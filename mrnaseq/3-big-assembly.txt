==============================
3. Running the Actual Assembly
==============================

.. shell start

All of the below should be run in screen, probably...  You will want
at least 15 GB of RAM, maybe more.

(If you start up a new machine, you'll need to go to
:doc:`1-quality` and install khmer and screed.)

.. note::

   You can start this tutorial with the contents of EC2/EBS snapshot
   snap-7b0b872e.

Installing Trinity
------------------

.. ::

   echo 3-big-assembly compileTrinity `date` >> times.out

To install Trinity:
::

   cd /root
   
   curl -L http://sourceforge.net/projects/trinityrnaseq/files/latest/download?source=files > trinity.tar.gz
   tar xzf trinity.tar.gz
   cd trinityrnaseq*/
   export FORCE_UNSAFE_CONFIGURE=1
   make

Install bowtie
--------------

.. ::

   echo 3-big-assembly installBowtie `date` >> times.out

Download and install bowtie:
::

   cd /root
   curl -O -L http://sourceforge.net/projects/bowtie-bio/files/bowtie/0.12.7/bowtie-0.12.7-linux-x86_64.zip
   unzip bowtie-0.12.7-linux-x86_64.zip
   cd bowtie-0.12.7
   cp bowtie bowtie-build bowtie-inspect /usr/local/bin

Install samtools
----------------

.. ::

   echo 3-big-assembly installSamtools `date` >> times.out

Download and install samtools:
::

   cd /root
   curl -L http://sourceforge.net/projects/samtools/files/latest/download?source=files >samtools.tar.bz2
   tar xjf samtools.tar.bz2
   mv samtools-* samtools-latest
   cd samtools-latest/
   make
   cp samtools bcftools/bcftools misc/* /usr/local/bin

Build the files to assemble
---------------------------

.. ::

   echo 3-big-assembly extractReads `date` >> times.out

For paired-end data, Trinity expects two files, 'left' and 'right';
there can be orphan sequences present, however.  So, below, we split
all of our interleaved pair files in two, and then add the single-ended
seqs to one of 'em. :
::

   cd /mnt/work
   for i in *.pe.qc.keep.abundfilt.fq.gz
   do
      split-paired-reads.py $i
   done
   
   cat *.1 > left.fq
   cat *.2 > right.fq
   
   gunzip -c *.se.qc.keep.abundfilt.fq.gz >> left.fq

Assembling with Trinity
-----------------------

.. ::

   echo 3-big-assembly assemble `date` >> times.out

Run the assembler! :
::

   /root/trinityrnaseq*/Trinity.pl --left left.fq --right right.fq --seqType fq -JM 10G

Note that this last bit (10G) is the maximum amount of memory to use.  You
can increase (or decrease) it based on what machine you rented.  This size
works for the m1.xlarge machines.

Once this completes (on the Nematostella data it might take about 12 hours),
you'll have an assembled transcriptome in trinity_out_dir/Trinity.fasta.

You can now copy it over via Dropbox, or set it up for BLAST (see
:doc:`installing-blastkit`).

.. shell stop

Next: :doc:`5-building-transcript-families` (or :doc:`installing-blastkit`).

.. shell start

.. for testing purposes:

.. ::

   echo 3-big-assembly test `date` >> times.out

.. ::

   cd /root
   curl -O ftp://ftp.ncbi.nih.gov/blast/executables/release/2.2.24/blast-2.2.24-x64-linux.tar.gz
   tar xzf blast-2.2.24-x64-linux.tar.gz
   cp blast-2.2.24/bin/* /usr/local/bin
   cp -r blast-2.2.24/data /usr/local/blast-data
   cd /mnt
   mkdir blast
   cd blast
   curl -O ftp://ftp.ncbi.nih.gov/refseq/M_musculus/mRNA_Prot/mouse.protein.faa.gz
   gunzip mouse.protein.faa.gz
   formatdb -i mouse.protein.faa -o T -p T
   cp ../work/trinity_out_dir/Trinity.fasta .
   blastall -i Trinity.fasta -d mouse.protein.faa -p blastx -e 1e-6 -o trinity.x.mouse
